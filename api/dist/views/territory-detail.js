import { jsx as _jsx, jsxs as _jsxs } from "hono/jsx/jsx-runtime";
import { Layout } from './layout';
const HOURS = [
    { key: 'sun', label: 'Sun' },
    { key: 'mon', label: 'Mon' },
    { key: 'tue', label: 'Tue' },
    { key: 'wed', label: 'Wed' },
    { key: 'thu', label: 'Thu' },
    { key: 'fri', label: 'Fri' },
    { key: 'sat', label: 'Sat' },
];
const TIMEZONES = ['America/Toronto', 'America/New_York', 'America/Vancouver', 'America/Chicago', 'America/Edmonton', 'UTC'];
const parseAreaData = (raw) => {
    try {
        return JSON.parse(raw || '{}');
    }
    catch {
        return {};
    }
};
const parseOperatingHours = (raw) => {
    try {
        const parsed = JSON.parse(raw || '{}');
        return parsed;
    }
    catch {
        return {};
    }
};
export const ZipPanel = ({ tid, zipCodes }) => {
    return (_jsx("div", { children: _jsxs("form", { class: "autosave", "hx-post": `/admin/territories/${tid}/area`, "hx-swap": "none", "hx-trigger": "input delay:800ms, change delay:800ms", children: [_jsx("input", { type: "hidden", name: "service_area_type", value: "zip" }), _jsxs("div", { class: "flex items-center justify-between mb-2", children: [_jsx("label", { class: "uk-form-label", for: "zip-codes", children: "ZIP/Postal Codes" }), _jsx("span", { class: "save-indicator" })] }), _jsxs("div", { class: "grid gap-2", children: [_jsx("textarea", { id: "zip-codes", name: "zip_codes", class: "uk-textarea", rows: 4, placeholder: "K8N1A1, K8N1A2", children: zipCodes.join(', ') }), _jsx("p", { class: "text-sm text-muted-foreground", children: "Comma-separated list." })] })] }) }));
};
export const RadiusPanel = ({ tid, areaData }) => {
    const center = areaData.center || {};
    const lat = Number(center.lat || 44.1628);
    const lng = Number(center.lng || -77.3832);
    const miles = Number(areaData.radius_miles || 10);
    return (_jsx("div", { children: _jsxs("form", { id: "radius-form", class: "autosave", "hx-post": `/admin/territories/${tid}/area`, "hx-swap": "none", "hx-trigger": "change delay:500ms", "hx-sync": "this:queue last", children: [_jsx("input", { type: "hidden", name: "service_area_type", value: "radius" }), _jsx("span", { class: "save-indicator" }), _jsxs("div", { class: "grid gap-3 sm:grid-cols-2 mb-4", children: [_jsxs("div", { class: "grid gap-2 sm:col-span-2", children: [_jsx("label", { class: "uk-form-label", for: "center-address-search", children: "Address Search" }), _jsx("input", { id: "center-address-search", name: "center_address_q", class: "uk-input", placeholder: "Search address", "hx-get": "/admin/api/address/search", "hx-trigger": "input changed delay:300ms", "hx-target": "#radius-address-results" }), _jsx("div", { id: "radius-address-results" })] }), _jsxs("div", { class: "grid gap-2", children: [_jsx("label", { class: "uk-form-label", for: "center-lat", children: "Center Latitude" }), _jsx("input", { id: "center-lat", name: "center_lat", class: "uk-input", value: lat.toString() })] }), _jsxs("div", { class: "grid gap-2", children: [_jsx("label", { class: "uk-form-label", for: "center-lng", children: "Center Longitude" }), _jsx("input", { id: "center-lng", name: "center_lng", class: "uk-input", value: lng.toString() })] }), _jsxs("div", { class: "grid gap-2 sm:col-span-2", children: [_jsx("label", { class: "uk-form-label", for: "radius-miles", children: "Radius (miles)" }), _jsx("input", { id: "radius-miles", name: "radius_miles", type: "number", min: 1, step: 0.1, class: "uk-input", value: miles.toString() })] })] }), _jsx("div", { id: "radius-map", style: "height: 300px; border: 1px solid var(--border); border-radius: 8px;", "data-lat": lat.toString(), "data-lng": lng.toString(), "data-miles": miles.toString() })] }) }));
};
export const GeofencePanel = ({ tid, areaData }) => {
    const polygon = Array.isArray(areaData.polygon) ? areaData.polygon : [];
    return (_jsx("div", { children: _jsxs("form", { id: "geofence-form", class: "autosave", "hx-post": `/admin/territories/${tid}/area`, "hx-swap": "none", "hx-trigger": "change delay:500ms", "hx-sync": "this:queue last", children: [_jsx("input", { type: "hidden", name: "service_area_type", value: "geofence" }), _jsxs("div", { class: "flex items-center gap-2 mb-3", children: [_jsx("button", { id: "gf-draw-btn", type: "button", class: "uk-btn uk-btn-default uk-btn-sm", children: "Draw Polygon" }), _jsx("button", { id: "clear-geofence-btn", type: "button", class: "uk-btn uk-btn-default uk-btn-sm", children: "Clear" }), _jsxs("span", { id: "gf-count", class: "text-sm text-muted-foreground", children: [polygon.length, " pts"] }), _jsx("span", { class: "save-indicator" })] }), _jsx("div", { id: "geofence-map", style: "height: 320px; border: 1px solid var(--border); border-radius: 8px;", "data-points": JSON.stringify(polygon) }), _jsx("input", { id: "polygon-json-hidden", type: "hidden", name: "polygon_json", value: polygon.length ? JSON.stringify(polygon) : '' })] }) }));
};
export const TerritoryDetailPage = ({ territory, services, providers, isNew }) => {
    const areaData = parseAreaData(territory.service_area_data);
    const zipCodes = (areaData.zip_codes || areaData.zipCodes || []).filter(Boolean);
    const operatingHours = parseOperatingHours(territory.operating_hours);
    const selectedType = territory.service_area_type || 'zip';
    const submitUrl = isNew ? '/admin/territories' : `/admin/territories/${territory.id}`;
    const assignedServices = services.filter((s) => s.assigned).length;
    const assignedProviders = providers.filter((p) => p.assigned).length;
    return (_jsxs(Layout, { title: isNew ? 'Create Territory' : territory.name || 'Territory', children: [_jsxs("div", { class: "page-header", children: [_jsx("h2", { children: isNew ? 'Create Territory' : territory.name || 'Territory' }), _jsx("div", { class: "page-header-actions", children: _jsx("a", { href: "/admin/territories", class: "uk-btn uk-btn-default uk-btn-sm", "hx-get": "/admin/territories", "hx-target": "#page-content", "hx-select": "#page-content", "hx-push-url": "true", children: "Back" }) })] }), _jsx("div", { class: "p-8", children: _jsxs("div", { class: "grid gap-6", style: "max-width: 800px;", children: [_jsx("div", { class: "uk-card uk-card-body", children: _jsxs("section", { children: [_jsx("h3", { class: "text-base font-semibold mb-4", children: "Basic Info" }), _jsxs("form", { "hx-post": submitUrl, "hx-target": "#page-content", "hx-select": "#page-content", "hx-push-url": "true", children: [!isNew && _jsx("input", { type: "hidden", name: "_section", value: "basic" }), _jsxs("div", { class: "grid gap-4 sm:grid-cols-2", children: [_jsxs("div", { class: "grid gap-2 sm:col-span-2", children: [_jsx("label", { class: "uk-form-label", for: "territory-name", children: "Name" }), _jsx("input", { id: "territory-name", name: "name", class: "uk-input", value: territory.name, required: true })] }), _jsxs("div", { class: "grid gap-2", children: [_jsx("label", { class: "uk-form-label", for: "territory-timezone", children: "Timezone" }), _jsx("select", { id: "territory-timezone", name: "timezone", class: "uk-select", children: TIMEZONES.map((tz) => _jsx("option", { value: tz, selected: territory.timezone === tz, children: tz }, tz)) })] }), _jsxs("div", { class: "grid gap-2", children: [_jsx("label", { class: "uk-form-label", for: "territory-policy", children: "Scheduling Policy" }), _jsxs("select", { id: "territory-policy", name: "scheduling_policy", class: "uk-select", children: [_jsx("option", { value: "provider_based", selected: territory.scheduling_policy === 'provider_based', children: "Provider based" }), _jsx("option", { value: "manual", selected: territory.scheduling_policy === 'manual', children: "Manual" })] })] }), _jsxs("label", { class: "uk-form-label flex items-center gap-2 cursor-pointer sm:col-span-2", children: [_jsx("input", { type: "checkbox", name: "is_active", checked: Boolean(territory.is_active), class: "uk-toggle-switch uk-toggle-switch-primary" }), "Active"] }), isNew && _jsx("input", { type: "hidden", name: "service_area_type", value: selectedType })] }), _jsx("div", { class: "mt-4", children: _jsx("button", { type: "submit", class: "uk-btn uk-btn-primary", children: isNew ? 'Create' : 'Save' }) })] })] }) }), !isNew && (_jsx("div", { class: "uk-card uk-card-body", children: _jsxs("section", { children: [_jsx("h3", { class: "text-base font-semibold mb-4", children: "Service Area" }), _jsx("div", { class: "grid gap-3 sm:grid-cols-2 items-end mb-4", children: _jsxs("div", { class: "grid gap-2", children: [_jsx("label", { class: "uk-form-label", for: "area-type", children: "Service Area Type" }), _jsxs("select", { id: "area-type", class: "uk-select", name: "panel_type", "hx-get": `/admin/territories/${territory.id}/area-panel/${selectedType}`, "hx-target": "#area-panel", "hx-swap": "innerHTML", "hx-trigger": "change", children: [_jsx("option", { value: "zip", selected: selectedType === 'zip', children: "ZIP / Postal Codes" }), _jsx("option", { value: "radius", selected: selectedType === 'radius', children: "Radius" }), _jsx("option", { value: "geofence", selected: selectedType === 'geofence', children: "Geofence" })] })] }) }), _jsxs("div", { id: "area-panel", children: [selectedType === 'radius' && RadiusPanel({ tid: territory.id, areaData }), selectedType === 'geofence' && GeofencePanel({ tid: territory.id, areaData }), selectedType === 'zip' && ZipPanel({ tid: territory.id, zipCodes })] })] }) })), !isNew && (_jsx("div", { class: "uk-card uk-card-body", children: _jsxs("section", { children: [_jsxs("div", { class: "flex items-center justify-between mb-4", children: [_jsx("h3", { class: "text-base font-semibold", children: "Operating Hours" }), _jsx("span", { class: "save-indicator" })] }), _jsx("form", { class: "autosave", "hx-post": `/admin/territories/${territory.id}/hours`, "hx-swap": "none", "hx-trigger": "change delay:500ms", "hx-sync": "this:queue last", children: _jsx("div", { class: "grid gap-3", children: HOURS.map((d) => {
                                                const row = operatingHours[d.key] || null;
                                                return (_jsxs("div", { class: "grid grid-cols-[60px_1fr_1fr_auto] gap-3 items-center", children: [_jsx("span", { class: "text-sm text-muted-foreground", children: d.label }), _jsx("input", { type: "time", name: `${d.key}_start`, class: "uk-input", value: row?.start || '09:00' }), _jsx("input", { type: "time", name: `${d.key}_end`, class: "uk-input", value: row?.end || '17:00' }), _jsxs("label", { class: "flex items-center gap-2 text-sm", children: [_jsx("input", { type: "checkbox", name: `${d.key}_enabled`, class: "uk-checkbox", checked: Boolean(row) }), "Enabled"] })] }, d.key));
                                            }) }) })] }) })), !isNew && (_jsx("div", { class: "uk-card uk-card-body", children: _jsxs("section", { id: "territory-services", children: [_jsxs("div", { class: "flex items-center justify-between mb-4", children: [_jsx("h3", { class: "text-base font-semibold", children: "Services" }), _jsxs("span", { id: "territory-services-count", class: "text-sm text-muted-foreground", children: [assignedServices, " assigned"] }), _jsx("span", { class: "save-indicator" })] }), _jsx("div", { class: "grid gap-2", children: services.map((s) => (_jsxs("label", { class: "flex items-center justify-between gap-3", children: [_jsx("span", { class: "text-sm", children: s.name }), _jsx("input", { type: "checkbox", class: "uk-checkbox", checked: s.assigned, "hx-post": `/admin/territories/${territory.id}/services/${s.id}/toggle`, "hx-trigger": "change", "hx-swap": "none" })] }, s.id))) })] }) })), !isNew && (_jsx("div", { class: "uk-card uk-card-body", children: _jsxs("section", { id: "territory-providers", children: [_jsxs("div", { class: "flex items-center justify-between mb-4", children: [_jsx("h3", { class: "text-base font-semibold", children: "Providers" }), _jsxs("span", { id: "territory-providers-count", class: "text-sm text-muted-foreground", children: [assignedProviders, " assigned"] }), _jsx("span", { class: "save-indicator" })] }), _jsx("div", { class: "grid gap-2", children: providers.map((p) => (_jsxs("label", { class: "flex items-center justify-between gap-3", children: [_jsxs("span", { class: "text-sm", children: [p.first_name, " ", p.last_name] }), _jsx("input", { type: "checkbox", class: "uk-checkbox", checked: p.assigned, "hx-post": `/admin/territories/${territory.id}/providers/${p.id}/toggle`, "hx-trigger": "change", "hx-swap": "none" })] }, p.id))) })] }) })), !isNew && (_jsx("div", { class: "uk-card uk-card-body danger-card", children: _jsxs("section", { children: [_jsx("h3", { class: "text-base font-semibold mb-3", children: "Delete" }), _jsx("button", { type: "button", class: "delete-btn", "hx-post": `/admin/territories/${territory.id}/delete`, "data-confirm": "arm", "hx-target": "#page-content", children: "Delete Territory" })] }) }))] }) })] }));
};
//# sourceMappingURL=territory-detail.js.map