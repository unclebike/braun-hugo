import { jsx as _jsx, jsxs as _jsxs } from "hono/jsx/jsx-runtime";
import { formatTorontoDate, formatTorontoTime } from '../utils/datetime';
import { StatusIcon } from './components';
import { Layout } from './layout';
const sourceBadge = (source) => {
    const cls = {
        contact: 'uk-label uk-label-primary',
        newsletter: 'uk-label uk-label-secondary',
        registration: 'uk-label',
        sms: 'uk-label uk-label-secondary',
    };
    return _jsx("span", { class: cls[source] || 'uk-label', children: source });
};
const statusBadge = (status) => {
    const cls = {
        new: 'uk-label uk-label-destructive',
        read: 'uk-label uk-label-secondary',
        replied: 'uk-label uk-label-primary',
        archived: 'uk-label',
    };
    if (status === 'read') {
        return _jsx(StatusIcon, { status: "read" });
    }
    return _jsx("span", { class: cls[status] || 'uk-label', children: status });
};
const smsStatusBadge = (status) => {
    if (status === 'sent') {
        return (_jsx("span", { title: "sent", style: "display:inline-flex;align-items:center;opacity:0.88;color:inherit;", children: _jsx("svg", { width: "13", height: "13", viewBox: "0 0 24 24", fill: "none", stroke: "currentColor", "stroke-width": "2", "stroke-linecap": "round", "stroke-linejoin": "round", "aria-hidden": "true", children: _jsx("path", { d: "M20 6L9 17L4 12" }) }) }));
    }
    if (status === 'delivered') {
        return (_jsx("span", { title: "delivered", style: "display:inline-flex;align-items:center;opacity:0.94;color:inherit;", children: _jsxs("svg", { width: "14", height: "14", viewBox: "0 0 24 24", fill: "none", stroke: "currentColor", "stroke-width": "2", "stroke-linecap": "round", "stroke-linejoin": "round", "aria-hidden": "true", children: [_jsx("path", { d: "M18 7L9 16L6 13" }), _jsx("path", { d: "M22 7L13 16L12 15" })] }) }));
    }
    const map = {
        failed: { cls: 'uk-label uk-label-destructive', label: 'failed' },
        undelivered: { cls: 'uk-label uk-label-destructive', label: 'undelivered' },
        queued: { cls: 'uk-label', label: 'queued' },
        received: { cls: 'uk-label uk-label-secondary', label: 'received' },
    };
    const info = map[status] || { cls: 'uk-label', label: status };
    return _jsx("span", { class: info.cls, style: "font-size:10px;padding:1px 6px;", children: info.label });
};
const formatDate = (d) => {
    if (!d)
        return '-';
    return formatTorontoDate(`${d}Z`, { year: 'numeric', month: 'short', day: 'numeric', hour: '2-digit', minute: '2-digit' }) || '-';
};
const formatTime = (d) => {
    return formatTorontoTime(`${d}Z`, { hour: '2-digit', minute: '2-digit' }) || d;
};
const smsBodyText = (sms) => (typeof sms.body === 'string' ? sms.body.trim() : '');
export const SmsHistoryList = ({ smsHistory, messageId, canCreateTask, jobOptions, selectedJobId, completedTaskSmsIds, }) => {
    const completedSet = new Set(completedTaskSmsIds);
    return (_jsx("div", { style: "display:flex;flex-direction:column;gap:8px;", children: smsHistory.length > 0 && (smsHistory
            .filter((sms) => smsBodyText(sms).length > 0)
            .map((sms) => {
            const taskCompleted = completedSet.has(sms.id);
            return (_jsx("div", { style: `display:flex;${sms.direction === 'outbound' ? 'justify-content:flex-end;' : 'justify-content:flex-start;'}`, children: _jsxs("div", { style: `max-width:80%;padding:8px 12px;border-radius:12px;display:flex;flex-direction:column;gap:6px;${sms.direction === 'outbound'
                        ? 'background:var(--brand,#dc8a78);color:var(--on-brand, #1e1e2e);border:1px solid rgba(0,0,0,0.06);border-bottom-right-radius:4px;'
                        : 'background:var(--surface-elevated,#eff1f5);color:var(--text-primary,#333);border:1px solid var(--border,#ccd0da);border-bottom-left-radius:4px;'}`, children: [_jsx("div", { class: "text-sm", style: "white-space:pre-wrap;word-break:break-word;", children: smsBodyText(sms) }), _jsxs("div", { style: "display:flex;align-items:center;justify-content:space-between;gap:8px;", children: [_jsx("span", { style: `font-size:11px;opacity:0.7;${sms.direction === 'outbound' ? 'color:#fff;' : ''}`, children: formatTime(sms.created_at) }), _jsxs("div", { style: "display:flex;align-items:center;gap:6px;", children: [sms.direction === 'outbound' && smsStatusBadge(sms.status), sms.direction === 'inbound' && canCreateTask && !taskCompleted && (_jsx("button", { type: "button", class: "uk-btn uk-btn-default uk-btn-small", "data-sms-task-url": `/admin/inbox/${messageId}/sms-task`, "data-sms-log-id": sms.id, "data-selected-job-id": selectedJobId || '', "data-job-options": JSON.stringify(jobOptions), "data-task-suggested-title": smsBodyText(sms).replace(/\s+/g, ' ').slice(0, 72), "aria-label": "Add task to job", title: "Add task to job", style: "padding:0;min-height:24px;min-width:24px;width:24px;height:24px;border-radius:999px;display:inline-flex;align-items:center;justify-content:center;", children: _jsxs("svg", { width: "13", height: "13", viewBox: "0 0 24 24", fill: "none", stroke: "currentColor", "stroke-width": "2", "stroke-linecap": "round", "stroke-linejoin": "round", "aria-hidden": "true", children: [_jsx("path", { d: "M12 5V19" }), _jsx("path", { d: "M5 12H19" })] }) })), sms.direction === 'inbound' && canCreateTask && taskCompleted && (_jsx("span", { class: "uk-label uk-label-secondary", title: "Task complete", style: "padding:0;min-width:24px;height:24px;border-radius:999px;display:inline-flex;align-items:center;justify-content:center;background:rgba(34,197,94,0.14);color:#15803d;border:1px solid rgba(21,128,61,0.35);", children: _jsx("svg", { width: "13", height: "13", viewBox: "0 0 24 24", fill: "none", stroke: "currentColor", "stroke-width": "2", "stroke-linecap": "round", "stroke-linejoin": "round", "aria-hidden": "true", children: _jsx("path", { d: "M20 6L9 17L4 12" }) }) }))] })] })] }) }, sms.id));
        })) }));
};
export const SmsThreadPanel = ({ messageId, smsHistory, twilioEnabled, phoneE164, customerName, jobOptions, selectedJobId, completedTaskSmsIds, sendResult, taskResult }) => {
    if (!twilioEnabled || !phoneE164)
        return null;
    const visibleSms = smsHistory.filter((sms) => smsBodyText(sms).length > 0);
    const lastSms = visibleSms.length > 0 ? visibleSms[visibleSms.length - 1] : null;
    const canCreateTask = jobOptions.length > 0;
    return (_jsxs("div", { id: "sms-thread-panel", class: "uk-card uk-card-body", children: [_jsxs("div", { class: "flex items-start justify-between gap-3 pb-3 mb-3", style: "border-bottom:1px solid var(--border);", "data-sms-thread-header": "1", children: [_jsxs("div", { class: "min-w-0", children: [_jsx("p", { class: "text-[11px] uppercase tracking-wide text-muted-foreground", children: "Thread" }), customerName && (_jsx("span", { "data-sms-thread-customer-name": "1", style: "display:none;", children: customerName })), _jsx("h3", { class: "text-sm font-semibold truncate", style: "margin-top:2px;", "data-sms-thread-phone": "1", children: phoneE164 }), _jsxs("p", { class: "text-xs text-muted-foreground", style: "margin-top:2px;", children: [visibleSms.length, " message", visibleSms.length === 1 ? '' : 's', lastSms ? ` • Last ${formatTime(lastSms.created_at)}` : ''] })] }), _jsxs("div", { class: "flex items-center gap-2 shrink-0", children: [_jsx("button", { type: "button", class: "uk-btn uk-btn-default uk-btn-sm", "data-sms-thread-modal-open": "move", "data-sms-thread-modal-title": customerName || '', "aria-label": "Open conversation full screen", style: "padding:0 10px;", children: "Full screen" }), _jsx("span", { class: "uk-label uk-label-secondary", children: "Live" })] })] }), sendResult && !sendResult.success && (_jsx("div", { class: "text-sm mb-3 px-3 py-2 rounded bg-red-50 text-red-700", "data-sms-send-result": "error", style: "background:rgba(239,68,68,0.1);color:#dc2626;", children: `Failed: ${sendResult.error}` })), taskResult && (_jsx("div", { class: `text-sm mb-3 px-3 py-2 rounded ${taskResult.success ? 'bg-green-50 text-green-700' : 'bg-red-50 text-red-700'}`, style: taskResult.success ? 'background:rgba(34,197,94,0.1);color:#15803d;' : 'background:rgba(239,68,68,0.1);color:#dc2626;', children: taskResult.success ? (taskResult.message || 'Task added to job') : `Task not added: ${taskResult.error}` })), !canCreateTask && (_jsx("p", { class: "text-xs text-muted-foreground mb-3", style: "margin-top:0;", children: "No jobs found for this customer yet." })), _jsxs("div", { "data-sms-thread-body": "1", children: [(visibleSms.length > 0 || sendResult) && (_jsx("div", { id: "sms-history-scroll", style: "max-height:400px;overflow-y:auto;padding:8px 0;", children: _jsx("div", { id: "sms-history", "hx-get": `/admin/inbox/${messageId}/sms-thread`, "hx-trigger": "load, every 5s", "hx-vals": `js:{_ts: Date.now()}`, "hx-swap": "innerHTML", children: _jsx(SmsHistoryList, { smsHistory: smsHistory, messageId: messageId, canCreateTask: canCreateTask, jobOptions: jobOptions, selectedJobId: selectedJobId, completedTaskSmsIds: completedTaskSmsIds }) }) })), _jsxs("form", { "hx-post": `/admin/inbox/${messageId}/sms-reply`, "hx-target": "#sms-thread-panel", "hx-swap": "outerHTML", style: "margin-top:12px;display:flex;flex-direction:column;gap:8px;", children: [_jsx("textarea", { name: "sms_body", class: "uk-textarea", rows: 3, placeholder: "Write a reply...", style: "resize:vertical;min-height:84px;font-size:16px;", maxlength: 1600, oninput: "var c=this.value.length;var s=c<=160?1:Math.ceil(c/153);var n=this.form&&this.form.querySelector('[data-sms-counter]');if(n){n.textContent=c+' chars \u00B7 '+s+' segment'+(s>1?'s':'');}" }), _jsxs("div", { class: "flex items-center justify-between gap-3", style: "flex-wrap:wrap;", children: [_jsx("span", { class: "text-xs text-muted-foreground", "data-sms-counter": true, children: "0 chars \u00B7 1 segment" }), _jsx("button", { type: "submit", class: "uk-btn uk-btn-primary uk-btn-sm", "data-sms-send-success": sendResult?.success ? 'true' : 'false', style: sendResult?.success
                                            ? 'min-width:110px;background:#16a34a;border-color:#15803d;color:#fff;'
                                            : 'min-width:110px;', children: "Send" })] })] })] })] }));
};
export const MessageDetailPage = ({ message, smsHistory, twilioEnabled, phoneE164, jobOptions, selectedJobId, completedTaskSmsIds, sendResult, taskResult }) => {
    let meta = null;
    if (message.metadata) {
        try {
            meta = JSON.parse(message.metadata);
        }
        catch {
            meta = null;
        }
    }
    const senderName = [message.first_name, message.last_name].filter(Boolean).join(' ') || message.email || 'Unknown';
    const showMessageBody = Boolean(message.body && message.body.trim().length > 0);
    const hasSmsContent = smsHistory.some((sms) => sms.body && sms.body.trim().length > 0);
    const showSmsPanel = twilioEnabled && !!phoneE164 && (hasSmsContent || !!sendResult || !!taskResult);
    const hasMetaDetails = Boolean(meta && Object.values(meta).some((val) => typeof val === 'string' && val.trim().length > 0));
    return (_jsxs(Layout, { title: `Message — ${senderName}`, children: [_jsxs("div", { class: "page-header", children: [_jsx("div", { class: "page-header-info", children: _jsx("h2", { style: "white-space:normal;word-break:break-word;", children: senderName }) }), _jsxs("div", { class: "page-header-actions", children: [message.status !== 'archived' && (_jsx("button", { type: "button", class: "uk-btn uk-btn-default uk-btn-sm", "hx-post": `/admin/inbox/${message.id}/archive`, "hx-target": "#page-content", "hx-select": "#page-content", "aria-label": "Archive message", title: "Archive message", style: "padding:0 10px;", children: _jsxs("svg", { width: "14", height: "14", viewBox: "0 0 24 24", fill: "none", stroke: "currentColor", "stroke-width": "2", "stroke-linecap": "round", "stroke-linejoin": "round", "aria-hidden": "true", children: [_jsx("rect", { x: "3", y: "4", width: "18", height: "4", rx: "1" }), _jsx("path", { d: "M5 8V20H19V8" }), _jsx("path", { d: "M10 12H14" })] }) })), _jsxs("a", { href: "/admin/inbox", class: "uk-btn uk-btn-default uk-btn-sm", "hx-get": "/admin/inbox", "hx-target": "#page-content", "hx-select": "#page-content", "hx-push-url": "true", "aria-label": "Back to inbox", title: "Back to inbox", style: "padding:0 10px;position:relative;", children: [_jsx("svg", { width: "14", height: "14", viewBox: "0 0 24 24", fill: "none", stroke: "currentColor", "stroke-width": "2", "stroke-linecap": "round", "stroke-linejoin": "round", "aria-hidden": "true", children: _jsx("path", { d: "M15 18L9 12L15 6" }) }), _jsx("span", { style: "position:absolute;width:1px;height:1px;padding:0;margin:-1px;overflow:hidden;clip:rect(0,0,0,0);white-space:nowrap;border:0;", children: "Back to inbox" })] })] })] }), _jsx("div", { class: "p-4 md:p-8", style: "padding-bottom:96px;", children: _jsxs("div", { class: "grid gap-4 md:gap-6", style: "max-width: 800px;", children: [_jsxs("div", { class: "uk-card uk-card-body", children: [_jsxs("div", { class: "flex items-start justify-between gap-3 mb-2", children: [_jsxs("div", { class: "min-w-0", children: [_jsx("p", { class: "text-[11px] uppercase tracking-wide text-muted-foreground", children: "Sender" }), _jsx("h3", { class: "text-sm font-semibold leading-tight break-words", style: "margin-top:2px;", children: senderName })] }), _jsxs("div", { class: "flex flex-wrap justify-end items-center gap-1.5 shrink-0", style: "max-width:52%;", children: [sourceBadge(message.source), statusBadge(message.status)] })] }), _jsxs("p", { class: "text-xs text-muted-foreground", style: "margin-bottom:10px;", children: ["Received ", formatDate(message.created_at)] }), _jsxs("div", { class: "grid gap-1.5 text-sm", children: [message.first_name && (_jsxs("div", { class: "flex items-start justify-between gap-3 rounded-md px-2.5 py-1.5", style: "background:var(--surface-elevated);", children: [_jsx("span", { class: "text-[11px] uppercase tracking-wide text-muted-foreground", children: "Name" }), _jsxs("p", { class: "font-medium leading-tight break-words text-right", children: [message.first_name, " ", message.last_name] })] })), message.email && (_jsxs("div", { class: "flex items-start justify-between gap-3 rounded-md px-2.5 py-1.5", style: "background:var(--surface-elevated);", children: [_jsx("span", { class: "text-[11px] uppercase tracking-wide text-muted-foreground", children: "Email" }), _jsx("p", { class: "font-medium leading-tight text-right", style: "max-width:70%;", children: _jsx("a", { href: `mailto:${message.email}`, class: "uk-link break-all", children: message.email }) })] })), message.phone && (_jsxs("div", { class: "flex items-start justify-between gap-3 rounded-md px-2.5 py-1.5", style: "background:var(--surface-elevated);", children: [_jsx("span", { class: "text-[11px] uppercase tracking-wide text-muted-foreground", children: "Phone" }), _jsx("p", { class: "font-medium leading-tight text-right", children: _jsx("a", { href: `tel:${message.phone}`, class: "uk-link", children: message.phone }) })] })), message.postal_code && (_jsxs("div", { class: "flex items-start justify-between gap-3 rounded-md px-2.5 py-1.5", style: "background:var(--surface-elevated);", children: [_jsx("span", { class: "text-[11px] uppercase tracking-wide text-muted-foreground", children: "Postal" }), _jsx("p", { class: "font-medium leading-tight text-right", children: message.postal_code })] })), message.reason && (_jsxs("div", { class: "flex items-start justify-between gap-3 rounded-md px-2.5 py-1.5", style: "background:var(--surface-elevated);", children: [_jsx("span", { class: "text-[11px] uppercase tracking-wide text-muted-foreground", children: "Reason" }), _jsx("p", { class: "font-medium leading-tight text-right", style: "text-transform: capitalize;", children: message.reason })] }))] })] }), showMessageBody && (_jsxs("div", { class: "uk-card uk-card-body", children: [_jsx("h3", { class: "text-base font-semibold mb-4", children: "Message" }), _jsx("div", { class: "text-sm leading-relaxed whitespace-pre-wrap", style: "color: #333;", children: message.body })] })), hasMetaDetails && meta && (_jsxs("div", { class: "uk-card uk-card-body", children: [_jsx("h3", { class: "text-base font-semibold mb-4", children: "Additional Details" }), _jsxs("div", { class: "grid gap-3 sm:grid-cols-2 text-sm", children: [meta.street_address && (_jsxs("div", { children: [_jsx("span", { class: "text-muted-foreground", children: "Street Address" }), _jsx("p", { class: "font-medium", children: meta.street_address })] })), meta.apt_suite && (_jsxs("div", { children: [_jsx("span", { class: "text-muted-foreground", children: "Apt/Suite" }), _jsx("p", { class: "font-medium", children: meta.apt_suite })] })), meta.city && (_jsxs("div", { children: [_jsx("span", { class: "text-muted-foreground", children: "City" }), _jsx("p", { class: "font-medium", children: meta.city })] })), meta.province && (_jsxs("div", { children: [_jsx("span", { class: "text-muted-foreground", children: "Province" }), _jsx("p", { class: "font-medium", children: meta.province })] })), meta.country && (_jsxs("div", { children: [_jsx("span", { class: "text-muted-foreground", children: "Country" }), _jsx("p", { class: "font-medium", children: meta.country })] })), meta.company && (_jsxs("div", { children: [_jsx("span", { class: "text-muted-foreground", children: "Company" }), _jsx("p", { class: "font-medium", children: meta.company })] })), meta.other && (_jsxs("div", { class: "sm:col-span-2", children: [_jsx("span", { class: "text-muted-foreground", children: "Other" }), _jsx("p", { class: "font-medium", children: meta.other })] }))] })] })), showSmsPanel && (_jsx(SmsThreadPanel, { messageId: message.id, smsHistory: smsHistory, twilioEnabled: twilioEnabled, phoneE164: phoneE164, customerName: senderName, jobOptions: jobOptions, selectedJobId: selectedJobId, completedTaskSmsIds: completedTaskSmsIds, sendResult: sendResult, taskResult: taskResult }))] }) })] }));
};
//# sourceMappingURL=message-detail.js.map